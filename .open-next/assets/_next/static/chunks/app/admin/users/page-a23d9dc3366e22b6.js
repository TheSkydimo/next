(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[674],{3655:function(t,e,d){Promise.resolve().then(d.bind(d,2573))},2573:function(t,e,d){"use strict";d.r(e),d.d(e,{default:function(){return o}});var i=d(7437),n=d(2265);function l(t){if(!t.activeSubscription||"ACTIVE"!==t.activeSubscription.status)return!0;let e=new Date;return new Date(t.activeSubscription.endAt)<=e}function o(){let[t,e]=(0,n.useState)([]),[d,o]=(0,n.useState)(!0),[a,s]=(0,n.useState)(null),[r,c]=(0,n.useState)(null),[u,p]=(0,n.useState)(1),[h,f]=(0,n.useState)(1);async function x(t){let d="ADMIN"===t.role?"USER":"ADMIN";if(window.confirm("确定要将用户「".concat(t.email,"」的角色切换为「").concat("ADMIN"===d?"管理员":"普通用户","」吗？")))try{c(t.id),s(null);let n=await fetch("/api/admin/users/".concat(t.id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:d})}),l=await n.json().catch(()=>({}));if(!n.ok||"OK"!==l.code||!l.data){var i;s(null!==(i=l.message)&&void 0!==i?i:"更新用户角色失败");return}e(e=>e.map(e=>e.id===t.id?{...e,role:d}:e))}catch(t){s("网络错误，更新用户角色失败")}finally{c(null)}}async function m(t){if(!l(t)){s("该用户当前仍在订阅期内，暂不允许删除");return}if(window.confirm("确定要删除用户「".concat(t.email,"」吗？此操作不可恢复。")))try{c(t.id),s(null);let i=await fetch("/api/admin/users/".concat(t.id),{method:"DELETE"}),n=await i.json().catch(()=>({}));if(!i.ok||"OK"!==n.code){var d;s(null!==(d=n.message)&&void 0!==d?d:"删除用户失败");return}e(e=>e.filter(e=>e.id!==t.id))}catch(t){s("网络错误，删除用户失败")}finally{c(null)}}return(0,n.useEffect)(()=>{(async function(t){try{var d,i,n,l,a,r;o(!0),s(null);let t=await fetch("/api/admin/users?page=".concat(1));if(401===t.status||403===t.status){let e=await t.text();try{let t=JSON.parse(e);s(null!==(n=t.message)&&void 0!==n?n:"没有权限访问用户管理")}catch(t){s("没有权限访问用户管理")}return}let c=await t.json().catch(()=>({}));if(!t.ok||"OK"!==c.code||!c.data){s(null!==(l=c.message)&&void 0!==l?l:"获取用户列表失败");return}e(c.data),p(null!==(a=null===(d=c.meta)||void 0===d?void 0:d.page)&&void 0!==a?a:1),f(null!==(r=null===(i=c.meta)||void 0===i?void 0:i.totalPages)&&void 0!==r?r:1)}catch(t){s("网络错误，获取用户列表失败")}finally{o(!1)}})(1)},[]),(0,i.jsxs)("section",{style:{maxWidth:960,margin:"24px auto",padding:"0 16px"},children:[(0,i.jsx)("h2",{children:"用户信息管理"}),a&&(0,i.jsx)("p",{style:{color:"red",marginTop:12},children:a}),d?(0,i.jsx)("p",{style:{marginTop:12},children:"加载中..."}):0===t.length?(0,i.jsx)("p",{style:{marginTop:12},children:"暂无用户数据。"}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse",marginTop:12,fontSize:14},children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"序号"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"邮箱"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"姓名"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"角色"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"订阅数"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"当前订阅"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"订单数"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"注册时间"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"最近更新"}),(0,i.jsx)("th",{style:{borderBottom:"1px solid #ddd",padding:8},children:"管理操作"})]})}),(0,i.jsx)("tbody",{children:t.map((t,e)=>{var d;return(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8,textAlign:"center"},children:e+1}),(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8},children:t.email}),(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8},children:null!==(d=t.name)&&void 0!==d?d:"未设置"}),(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8,textAlign:"center"},children:"ADMIN"===t.role?"管理员":"普通用户"}),(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8,textAlign:"center"},children:t.subscriptionsCount}),(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8},children:t.activeSubscription?(0,i.jsxs)("div",{style:{lineHeight:1.6},children:[(0,i.jsx)("div",{children:t.activeSubscription.planName}),(0,i.jsxs)("div",{style:{fontSize:12,color:"#555"},children:["状态：","ACTIVE"===t.activeSubscription.status?"生效中":"CANCELED"===t.activeSubscription.status?"已取消":"已过期"]}),(0,i.jsxs)("div",{style:{fontSize:12,color:"#555"},children:["到期：",new Date(t.activeSubscription.endAt).toLocaleDateString()]})]}):(0,i.jsx)("span",{style:{fontSize:12,color:"#999"},children:"暂无生效订阅"})}),(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8,textAlign:"center"},children:t.ordersCount}),(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8},children:new Date(t.createdAt).toLocaleString()}),(0,i.jsx)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8},children:new Date(t.updatedAt).toLocaleString()}),(0,i.jsxs)("td",{style:{borderBottom:"1px solid #f0f0f0",padding:8,textAlign:"center"},children:[(0,i.jsx)("button",{type:"button",disabled:r===t.id,onClick:()=>void x(t),children:"ADMIN"===t.role?"设为普通用户":"设为管理员"}),(0,i.jsx)("button",{type:"button",style:{marginLeft:8,color:"red"},disabled:r===t.id||!l(t),onClick:()=>void m(t),children:"删除"})]})]},t.id)})})]}),(0,i.jsxs)("div",{style:{marginTop:16,display:"flex",justifyContent:"flex-end",alignItems:"center",gap:12,fontSize:14},children:[(0,i.jsxs)("span",{children:["第 ",u," / ",h," 页"]}),(0,i.jsx)("button",{type:"button",disabled:u<=1||d,onClick:()=>{u>1&&!d&&(async()=>{try{var t,d,i,n,l;o(!0),s(null);let a=await fetch("/api/admin/users?page=".concat(u-1)),r=await a.json().catch(()=>({code:"UNKNOWN_ERROR"}));if(!a.ok||"OK"!==r.code||!r.data){s(null!==(i=r.message)&&void 0!==i?i:"获取用户列表失败");return}e(r.data),p(null!==(n=null===(t=r.meta)||void 0===t?void 0:t.page)&&void 0!==n?n:u-1),f(null!==(l=null===(d=r.meta)||void 0===d?void 0:d.totalPages)&&void 0!==l?l:1)}catch(t){s("网络错误，获取用户列表失败")}finally{o(!1)}})()},children:"上一页"}),(0,i.jsx)("button",{type:"button",disabled:u>=h||d,onClick:()=>{u<h&&!d&&(async()=>{try{var t,d,i,n,l;o(!0),s(null);let a=await fetch("/api/admin/users?page=".concat(u+1)),r=await a.json().catch(()=>({code:"UNKNOWN_ERROR"}));if(!a.ok||"OK"!==r.code||!r.data){s(null!==(i=r.message)&&void 0!==i?i:"获取用户列表失败");return}e(r.data),p(null!==(n=null===(t=r.meta)||void 0===t?void 0:t.page)&&void 0!==n?n:u+1),f(null!==(l=null===(d=r.meta)||void 0===d?void 0:d.totalPages)&&void 0!==l?l:1)}catch(t){s("网络错误，获取用户列表失败")}finally{o(!1)}})()},children:"下一页"})]})]})]})}}},function(t){t.O(0,[971,23,744],function(){return t(t.s=3655)}),_N_E=t.O()}]);